# SPDX-License-Identifier: GPL-3.0-or-later
#
# HelixScreen - Creality K1 Series (MIPS32) Cross-Compilation Toolchain
#
# Build: docker build -t helixscreen/toolchain-k1 -f Dockerfile.k1 .
# Usage: docker run --rm -v $(pwd):/src -w /src helixscreen/toolchain-k1 make PLATFORM_TARGET=k1 -j$(nproc)
#
# Target: Creality K1C, K1 Max, K2 Plus (and other Ingenic X2000E devices)
#   - CPU: Ingenic X2000E, MIPS32r2 dual-core @ 1.2 GHz
#   - Display: 480x400 (K1), 480x800 (K2)
#   - RAM: 256MB
#   - C Library: musl (static linking)
#
# Strategy: Use Bootlin's pre-built mips32el musl toolchain with STATIC linking.
# Musl produces cleaner static binaries than glibc - no getaddrinfo warnings,
# smaller size, and simpler deployment.
#
# Based on pellcorp/grumpyscreen's proven toolchain setup.
#
# Toolchain source: https://toolchains.bootlin.com/

FROM debian:bookworm-slim

LABEL maintainer="HelixScreen <dev@helixscreen.io>"
LABEL description="Cross-compilation toolchain for Creality K1 series (MIPS32 Ingenic X2000E)"

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
# Note: autotools required for building libnl submodule
# NOTE: nlohmann-json is bundled with libhv (lib/libhv/cpputil/json.hpp)
# DO NOT install nlohmann-json3-dev - it causes ABI mismatches
# Always use: #include "hv/json.hpp" (NOT <nlohmann/json.hpp>)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    pkg-config \
    ca-certificates \
    make \
    cmake \
    python3 \
    file \
    wget \
    xz-utils \
    bzip2 \
    autoconf \
    automake \
    libtool \
    flex \
    bison \
    && rm -rf /var/lib/apt/lists/*

# Download Bootlin's mips32el musl toolchain (stable-2024.02-1)
# This is the same toolchain used by pellcorp/grumpyscreen for K1 support
# Musl-based for clean static linking
WORKDIR /opt
RUN wget -q "https://toolchains.bootlin.com/downloads/releases/toolchains/mips32el/tarballs/mips32el--musl--stable-2024.02-1.tar.bz2" && \
    tar xjf "mips32el--musl--stable-2024.02-1.tar.bz2" && \
    rm "mips32el--musl--stable-2024.02-1.tar.bz2" && \
    mv "mips32el--musl--stable-2024.02-1" mips-toolchain

# ==============================================================================
# Cross-Compilation Environment
# ==============================================================================

ENV PATH="/opt/mips-toolchain/bin:$PATH"
ENV CROSS_COMPILE=mipsel-buildroot-linux-musl-
ENV CC=mipsel-buildroot-linux-musl-gcc
ENV CXX=mipsel-buildroot-linux-musl-g++
# Use gcc-ar and gcc-ranlib for LTO compatibility (they load the LTO plugin)
ENV AR=mipsel-buildroot-linux-musl-gcc-ar
ENV STRIP=mipsel-buildroot-linux-musl-strip
ENV RANLIB=mipsel-buildroot-linux-musl-gcc-ranlib
ENV LD=mipsel-buildroot-linux-musl-ld

# Target-specific flags for MIPS32r2 (Ingenic X2000E)
# Note: -static is added in cross.mk, not here (so libs can be built dynamically)
ENV TARGET_CFLAGS="-march=mips32r2 -mtune=mips32r2"
ENV TARGET_LDFLAGS=""

# Working directory
WORKDIR /src

# Verify the toolchain works (including LTO-aware tools)
RUN mipsel-buildroot-linux-musl-gcc --version && \
    mipsel-buildroot-linux-musl-g++ --version && \
    mipsel-buildroot-linux-musl-gcc-ar --version && \
    mipsel-buildroot-linux-musl-gcc-ranlib --version && \
    echo "Toolchain verification passed (including LTO support)" && \
    echo "" && \
    echo "NOTE: This toolchain uses musl libc with STATIC linking" && \
    echo "for clean, portable binaries on K1 series printers."

# Default command: build for K1
CMD ["make", "PLATFORM_TARGET=k1", "-j"]
